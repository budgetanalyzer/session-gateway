server:
  port: 8081
  # Listen on all interfaces so NGINX container can reach us via host.docker.internal
  address: 0.0.0.0
  # Enable forward headers strategy for WebFlux
  # This ensures Spring Security correctly constructs redirect URIs when behind NGINX proxy
  # Without this, the redirect_uri sent to Auth0 may be incorrect
  forward-headers-strategy: framework
  # Note: SSL is handled by NGINX - Session Gateway runs on HTTP internally

logging:
  level:
    root: WARN
    org.budgetanalyzer: TRACE
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security: INFO
    org.springframework.security.oauth2: DEBUG
    org.springframework.web.reactive.function.client: DEBUG

spring:
  application:
    name: session-gateway

  # Redis configuration for session storage
  data:
    redis:
      host: localhost  # Use 'redis' when running in Docker
      port: 6379
      timeout: 2000ms

  # Session management with Redis
  session:
    store-type: redis
    timeout: 30m  # 30 minutes session timeout
    redis:
      flush-mode: on_save
      namespace: spring:session

  # OAuth2 Client configuration (Auth0)
  # Phase 2 Task 2.1: Configure OAuth2 with PKCE flow
  security:
    oauth2:
      client:
        registration:
          auth0:
            client-id: ${AUTH0_CLIENT_ID:placeholder-client-id}
            client-secret: ${AUTH0_CLIENT_SECRET:placeholder-client-secret}
            scope:
              - openid
              - profile
              - email
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            # Auth0 specific: request audience to get JWT access token
            client-authentication-method: client_secret_basic
        provider:
          auth0:
            issuer-uri: ${AUTH0_ISSUER_URI:https://placeholder.auth0.com/}

  # Spring Cloud Gateway routes
  cloud:
    gateway:
      server:
        webflux:
          httpclient:
            wiretap: true
          routes:
            # Route all /api/* requests to NGINX gateway (backend APIs)
            - id: api-route
              uri: https://api.budgetanalyzer.localhost  # Use 'https://nginx-gateway:443' when running in Docker
              predicates:
                - Path=/api/**
              filters:
                # Phase 2: OAuth2 token forwarding handled by OAuth2TokenRelayGatewayFilter (WebFilter)
                # TokenRelay and TokenRefresh filters are not compatible with Spring Cloud Gateway Server
                - StripPrefix=0  # Keep the /api prefix when forwarding

            # Route all frontend requests to Vite dev server (static files and React app)
            # All non-API requests (except /user, /logout, /oauth2/*) proxy to Vite
            - id: frontend-route
              uri: http://budget-analyzer-web:3000  # Vite dev server in Kubernetes
              predicates:
                - Path=/**
              filters:
                - StripPrefix=0
              # Lower priority than api-route, /user, /logout, /oauth2/* routes
              order: 10000

# Session cookie configuration
session:
  cookie:
    # Domain override for session cookies.
    #
    # WORKAROUND: Envoy Gateway rewrites the Host header to pod IP addresses instead of
    # preserving the original hostname (app.budgetanalyzer.localhost). This breaks dynamic
    # domain extraction since IP addresses cannot be used as cookie domains.
    #
    # Expected: Host header = "app.budgetanalyzer.localhost" → extracted domain = "budgetanalyzer.localhost"
    # Actual: Host header = "10.244.0.18:8081" → extracted domain = null (IPs not allowed)
    #
    # This override ensures cookies are correctly scoped to share across subdomains.
    # When Envoy is fixed to preserve Host headers, this can be removed and dynamic
    # extraction will work. Check logs for "DOMAIN MATCH" to verify.
    domain-override: budgetanalyzer.localhost

# Auth0 specific configuration
auth0:
  audience: ${AUTH0_AUDIENCE:https://api.budgetanalyzer.org}
  logout:
    return-to: ${AUTH0_LOGOUT_RETURN_TO:https://app.budgetanalyzer.localhost}  # Where to redirect after logout (Session Gateway)

# Budget Analyzer Common Configuration
budgetanalyzer:
  service:
    http-logging:
      enabled: true
      log-level: DEBUG
      include-request-body: true
      include-response-body: true
      include-request-headers: true
      include-response-headers: true
      include-query-params: true
      include-client-ip: true
      max-body-size: 10000  # 10KB max body size to log
      # Default exclude-patterns: /actuator/**, /swagger-ui/**, /v3/api-docs/**
      # Sensitive headers are automatically masked (Authorization, Cookie, Set-Cookie, etc.)
      log-errors-only: false

# Actuator configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
